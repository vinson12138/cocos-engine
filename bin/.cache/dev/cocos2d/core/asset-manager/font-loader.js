
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/font-loader.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var textUtils = require('../utils/text-utils');

var _canvasContext = null; // letter symbol number CJK

var _testString = "BES bswy:->@123\u4E01\u3041\u1101";

var _fontFaces = Object.create(null);

var _intervalId = -1;

var _loadingFonts = []; // 3 seconds timeout

var _timeout = 3000; // Refer to https://github.com/typekit/webfontloader/blob/master/src/core/fontwatcher.js

var useNativeCheck = function () {
  var nativeCheck = undefined;
  return function () {
    if (nativeCheck === undefined) {
      if (!!window.FontFace) {
        var match = /Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent);
        var safari10Match = /OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent) && /Apple/.exec(window.navigator.vendor);

        if (match) {
          nativeCheck = parseInt(match[1], 10) > 42;
        } else if (safari10Match) {
          nativeCheck = false;
        } else {
          nativeCheck = true;
        }
      } else {
        nativeCheck = false;
      }
    }

    return nativeCheck;
  };
}();

function _checkFontLoaded() {
  var allFontsLoaded = true;
  var now = Date.now();

  for (var i = _loadingFonts.length - 1; i >= 0; i--) {
    var fontLoadHandle = _loadingFonts[i];
    var fontFamily = fontLoadHandle.fontFamilyName; // load timeout

    if (now - fontLoadHandle.startTime > _timeout) {
      cc.warnID(4933, fontFamily);
      fontLoadHandle.onComplete(null, fontFamily);

      _loadingFonts.splice(i, 1);

      continue;
    }

    var oldWidth = fontLoadHandle.refWidth;
    var fontDesc = '40px ' + fontFamily;
    _canvasContext.font = fontDesc;
    var newWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // loaded successfully

    if (oldWidth !== newWidth) {
      _loadingFonts.splice(i, 1);

      fontLoadHandle.onComplete(null, fontFamily);
    } else {
      allFontsLoaded = false;
    }
  }

  if (allFontsLoaded) {
    clearInterval(_intervalId);
    _intervalId = -1;
  }
} // refer to https://github.com/typekit/webfontloader/blob/master/src/core/nativefontwatchrunner.js


function nativeCheckFontLoaded(start, font, callback) {
  var loader = new Promise(function (resolve, reject) {
    var check = function check() {
      var now = Date.now();

      if (now - start >= _timeout) {
        reject();
      } else {
        document.fonts.load('40px ' + font).then(function (fonts) {
          if (fonts.length >= 1) {
            resolve();
          } else {
            setTimeout(check, 100);
          }
        }, function () {
          reject();
        });
      }
    };

    check();
  });
  var timeoutId = null,
      timer = new Promise(function (resolve, reject) {
    timeoutId = setTimeout(reject, _timeout);
  });
  Promise.race([timer, loader]).then(function () {
    if (timeoutId) {
      clearTimeout(timeoutId);
      timeoutId = null;
    }

    callback(null, font);
  }, function () {
    cc.warnID(4933, font);
    callback(null, font);
  });
}

var fontLoader = {
  loadFont: function loadFont(url, options, onComplete) {
    var fontFamilyName = fontLoader._getFontFamily(url); // Already loaded fonts


    if (_fontFaces[fontFamilyName]) {
      return onComplete(null, fontFamilyName);
    }

    if (!_canvasContext) {
      var labelCanvas = document.createElement('canvas');
      labelCanvas.width = 100;
      labelCanvas.height = 100;
      _canvasContext = labelCanvas.getContext('2d');
    } // Default width reference to test whether new font is loaded correctly


    var fontDesc = '40px ' + fontFamilyName;
    _canvasContext.font = fontDesc;
    var refWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // Setup font face style

    var fontStyle = document.createElement("style");
    fontStyle.type = "text/css";
    var fontStr = "";
    if (isNaN(fontFamilyName - 0)) fontStr += "@font-face { font-family:" + fontFamilyName + "; src:";else fontStr += "@font-face { font-family:'" + fontFamilyName + "'; src:";
    fontStr += "url('" + url + "');";
    fontStyle.textContent = fontStr + "}";
    document.body.appendChild(fontStyle); // Preload font with div

    var preloadDiv = document.createElement("div");
    var divStyle = preloadDiv.style;
    divStyle.fontFamily = fontFamilyName;
    preloadDiv.innerHTML = ".";
    divStyle.position = "absolute";
    divStyle.left = "-100px";
    divStyle.top = "-100px";
    document.body.appendChild(preloadDiv);

    if (useNativeCheck()) {
      nativeCheckFontLoaded(Date.now(), fontFamilyName, onComplete);
    } else {
      // Save loading font
      var fontLoadHandle = {
        fontFamilyName: fontFamilyName,
        refWidth: refWidth,
        onComplete: onComplete,
        startTime: Date.now()
      };

      _loadingFonts.push(fontLoadHandle);

      if (_intervalId === -1) {
        _intervalId = setInterval(_checkFontLoaded, 100);
      }
    }

    _fontFaces[fontFamilyName] = fontStyle;
  },
  _getFontFamily: function _getFontFamily(fontHandle) {
    var ttfIndex = fontHandle.lastIndexOf(".ttf");
    if (ttfIndex === -1) return fontHandle;
    var slashPos = fontHandle.lastIndexOf("/");
    var fontFamilyName;

    if (slashPos === -1) {
      fontFamilyName = fontHandle.substring(0, ttfIndex) + "_LABEL";
    } else {
      fontFamilyName = fontHandle.substring(slashPos + 1, ttfIndex) + "_LABEL";
    }

    if (fontFamilyName.indexOf(' ') !== -1) {
      fontFamilyName = '"' + fontFamilyName + '"';
    }

    return fontFamilyName;
  }
};
module.exports = fontLoader;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL2Fzc2V0LW1hbmFnZXIvZm9udC1sb2FkZXIuanMiXSwibmFtZXMiOlsidGV4dFV0aWxzIiwicmVxdWlyZSIsIl9jYW52YXNDb250ZXh0IiwiX3Rlc3RTdHJpbmciLCJfZm9udEZhY2VzIiwiT2JqZWN0IiwiY3JlYXRlIiwiX2ludGVydmFsSWQiLCJfbG9hZGluZ0ZvbnRzIiwiX3RpbWVvdXQiLCJ1c2VOYXRpdmVDaGVjayIsIm5hdGl2ZUNoZWNrIiwidW5kZWZpbmVkIiwid2luZG93IiwiRm9udEZhY2UiLCJtYXRjaCIsImV4ZWMiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJzYWZhcmkxME1hdGNoIiwidmVuZG9yIiwicGFyc2VJbnQiLCJfY2hlY2tGb250TG9hZGVkIiwiYWxsRm9udHNMb2FkZWQiLCJub3ciLCJEYXRlIiwiaSIsImxlbmd0aCIsImZvbnRMb2FkSGFuZGxlIiwiZm9udEZhbWlseSIsImZvbnRGYW1pbHlOYW1lIiwic3RhcnRUaW1lIiwiY2MiLCJ3YXJuSUQiLCJvbkNvbXBsZXRlIiwic3BsaWNlIiwib2xkV2lkdGgiLCJyZWZXaWR0aCIsImZvbnREZXNjIiwiZm9udCIsIm5ld1dpZHRoIiwic2FmZU1lYXN1cmVUZXh0IiwiY2xlYXJJbnRlcnZhbCIsIm5hdGl2ZUNoZWNrRm9udExvYWRlZCIsInN0YXJ0IiwiY2FsbGJhY2siLCJsb2FkZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImNoZWNrIiwiZG9jdW1lbnQiLCJmb250cyIsImxvYWQiLCJ0aGVuIiwic2V0VGltZW91dCIsInRpbWVvdXRJZCIsInRpbWVyIiwicmFjZSIsImNsZWFyVGltZW91dCIsImZvbnRMb2FkZXIiLCJsb2FkRm9udCIsInVybCIsIm9wdGlvbnMiLCJfZ2V0Rm9udEZhbWlseSIsImxhYmVsQ2FudmFzIiwiY3JlYXRlRWxlbWVudCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0Q29udGV4dCIsImZvbnRTdHlsZSIsInR5cGUiLCJmb250U3RyIiwiaXNOYU4iLCJ0ZXh0Q29udGVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsInByZWxvYWREaXYiLCJkaXZTdHlsZSIsInN0eWxlIiwiaW5uZXJIVE1MIiwicG9zaXRpb24iLCJsZWZ0IiwidG9wIiwicHVzaCIsInNldEludGVydmFsIiwiZm9udEhhbmRsZSIsInR0ZkluZGV4IiwibGFzdEluZGV4T2YiLCJzbGFzaFBvcyIsInN1YnN0cmluZyIsImluZGV4T2YiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsSUFBTUEsU0FBUyxHQUFHQyxPQUFPLENBQUMscUJBQUQsQ0FBekI7O0FBRUEsSUFBSUMsY0FBYyxHQUFHLElBQXJCLEVBQ0E7O0FBQ0EsSUFBSUMsV0FBVyxHQUFHLG1DQUFsQjs7QUFFQSxJQUFJQyxVQUFVLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLElBQWQsQ0FBakI7O0FBQ0EsSUFBSUMsV0FBVyxHQUFHLENBQUMsQ0FBbkI7O0FBQ0EsSUFBSUMsYUFBYSxHQUFHLEVBQXBCLEVBQ0E7O0FBQ0EsSUFBSUMsUUFBUSxHQUFHLElBQWYsRUFFQTs7QUFDQSxJQUFJQyxjQUFjLEdBQUksWUFBWTtBQUM5QixNQUFJQyxXQUFXLEdBQUdDLFNBQWxCO0FBQ0EsU0FBTyxZQUFZO0FBQ2YsUUFBSUQsV0FBVyxLQUFLQyxTQUFwQixFQUErQjtBQUMzQixVQUFJLENBQUMsQ0FBQ0MsTUFBTSxDQUFDQyxRQUFiLEVBQXVCO0FBQ25CLFlBQUlDLEtBQUssR0FBRyx3QkFBd0JDLElBQXhCLENBQTZCSCxNQUFNLENBQUNJLFNBQVAsQ0FBaUJDLFNBQTlDLENBQVo7QUFDQSxZQUFJQyxhQUFhLEdBQUcsOEJBQThCSCxJQUE5QixDQUFtQ0gsTUFBTSxDQUFDSSxTQUFQLENBQWlCQyxTQUFwRCxLQUFrRSxRQUFRRixJQUFSLENBQWFILE1BQU0sQ0FBQ0ksU0FBUCxDQUFpQkcsTUFBOUIsQ0FBdEY7O0FBRUEsWUFBSUwsS0FBSixFQUFXO0FBQ1BKLFVBQUFBLFdBQVcsR0FBR1UsUUFBUSxDQUFDTixLQUFLLENBQUMsQ0FBRCxDQUFOLEVBQVcsRUFBWCxDQUFSLEdBQXlCLEVBQXZDO0FBQ0gsU0FGRCxNQUdLLElBQUlJLGFBQUosRUFBbUI7QUFDcEJSLFVBQUFBLFdBQVcsR0FBRyxLQUFkO0FBQ0gsU0FGSSxNQUdBO0FBQ0RBLFVBQUFBLFdBQVcsR0FBRyxJQUFkO0FBQ0g7QUFFSixPQWRELE1BY087QUFDSEEsUUFBQUEsV0FBVyxHQUFHLEtBQWQ7QUFDSDtBQUNKOztBQUVELFdBQU9BLFdBQVA7QUFFSCxHQXZCRDtBQXdCSCxDQTFCb0IsRUFBckI7O0FBNEJBLFNBQVNXLGdCQUFULEdBQTZCO0FBQ3pCLE1BQUlDLGNBQWMsR0FBRyxJQUFyQjtBQUNBLE1BQUlDLEdBQUcsR0FBR0MsSUFBSSxDQUFDRCxHQUFMLEVBQVY7O0FBRUEsT0FBSyxJQUFJRSxDQUFDLEdBQUdsQixhQUFhLENBQUNtQixNQUFkLEdBQXVCLENBQXBDLEVBQXVDRCxDQUFDLElBQUksQ0FBNUMsRUFBK0NBLENBQUMsRUFBaEQsRUFBb0Q7QUFDaEQsUUFBSUUsY0FBYyxHQUFHcEIsYUFBYSxDQUFDa0IsQ0FBRCxDQUFsQztBQUNBLFFBQUlHLFVBQVUsR0FBR0QsY0FBYyxDQUFDRSxjQUFoQyxDQUZnRCxDQUdoRDs7QUFDQSxRQUFJTixHQUFHLEdBQUdJLGNBQWMsQ0FBQ0csU0FBckIsR0FBaUN0QixRQUFyQyxFQUErQztBQUMzQ3VCLE1BQUFBLEVBQUUsQ0FBQ0MsTUFBSCxDQUFVLElBQVYsRUFBZ0JKLFVBQWhCO0FBQ0FELE1BQUFBLGNBQWMsQ0FBQ00sVUFBZixDQUEwQixJQUExQixFQUFnQ0wsVUFBaEM7O0FBQ0FyQixNQUFBQSxhQUFhLENBQUMyQixNQUFkLENBQXFCVCxDQUFyQixFQUF3QixDQUF4Qjs7QUFDQTtBQUNIOztBQUVELFFBQUlVLFFBQVEsR0FBR1IsY0FBYyxDQUFDUyxRQUE5QjtBQUNBLFFBQUlDLFFBQVEsR0FBRyxVQUFVVCxVQUF6QjtBQUNBM0IsSUFBQUEsY0FBYyxDQUFDcUMsSUFBZixHQUFzQkQsUUFBdEI7QUFDQSxRQUFJRSxRQUFRLEdBQUd4QyxTQUFTLENBQUN5QyxlQUFWLENBQTBCdkMsY0FBMUIsRUFBMENDLFdBQTFDLEVBQXVEbUMsUUFBdkQsQ0FBZixDQWRnRCxDQWVoRDs7QUFDQSxRQUFJRixRQUFRLEtBQUtJLFFBQWpCLEVBQTJCO0FBQ3ZCaEMsTUFBQUEsYUFBYSxDQUFDMkIsTUFBZCxDQUFxQlQsQ0FBckIsRUFBd0IsQ0FBeEI7O0FBQ0FFLE1BQUFBLGNBQWMsQ0FBQ00sVUFBZixDQUEwQixJQUExQixFQUFnQ0wsVUFBaEM7QUFDSCxLQUhELE1BSUs7QUFDRE4sTUFBQUEsY0FBYyxHQUFHLEtBQWpCO0FBQ0g7QUFDSjs7QUFFRCxNQUFJQSxjQUFKLEVBQW9CO0FBQ2hCbUIsSUFBQUEsYUFBYSxDQUFDbkMsV0FBRCxDQUFiO0FBQ0FBLElBQUFBLFdBQVcsR0FBRyxDQUFDLENBQWY7QUFDSDtBQUNKLEVBRUQ7OztBQUNBLFNBQVNvQyxxQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUNMLElBQXZDLEVBQTZDTSxRQUE3QyxFQUF1RDtBQUNuRCxNQUFJQyxNQUFNLEdBQUcsSUFBSUMsT0FBSixDQUFZLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ2hELFFBQUlDLEtBQUssR0FBRyxTQUFSQSxLQUFRLEdBQVk7QUFDcEIsVUFBSTFCLEdBQUcsR0FBR0MsSUFBSSxDQUFDRCxHQUFMLEVBQVY7O0FBRUEsVUFBSUEsR0FBRyxHQUFHb0IsS0FBTixJQUFlbkMsUUFBbkIsRUFBNkI7QUFDekJ3QyxRQUFBQSxNQUFNO0FBQ1QsT0FGRCxNQUdLO0FBQ0RFLFFBQUFBLFFBQVEsQ0FBQ0MsS0FBVCxDQUFlQyxJQUFmLENBQW9CLFVBQVVkLElBQTlCLEVBQW9DZSxJQUFwQyxDQUF5QyxVQUFVRixLQUFWLEVBQWlCO0FBQ3RELGNBQUlBLEtBQUssQ0FBQ3pCLE1BQU4sSUFBZ0IsQ0FBcEIsRUFBdUI7QUFDbkJxQixZQUFBQSxPQUFPO0FBQ1YsV0FGRCxNQUdLO0FBQ0RPLFlBQUFBLFVBQVUsQ0FBQ0wsS0FBRCxFQUFRLEdBQVIsQ0FBVjtBQUNIO0FBQ0osU0FQRCxFQU9HLFlBQVk7QUFDWEQsVUFBQUEsTUFBTTtBQUNULFNBVEQ7QUFVSDtBQUNKLEtBbEJEOztBQW9CQUMsSUFBQUEsS0FBSztBQUNSLEdBdEJZLENBQWI7QUF3QkEsTUFBSU0sU0FBUyxHQUFHLElBQWhCO0FBQUEsTUFDQUMsS0FBSyxHQUFHLElBQUlWLE9BQUosQ0FBWSxVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUMzQ08sSUFBQUEsU0FBUyxHQUFHRCxVQUFVLENBQUNOLE1BQUQsRUFBU3hDLFFBQVQsQ0FBdEI7QUFDSCxHQUZPLENBRFI7QUFLQXNDLEVBQUFBLE9BQU8sQ0FBQ1csSUFBUixDQUFhLENBQUNELEtBQUQsRUFBUVgsTUFBUixDQUFiLEVBQThCUSxJQUE5QixDQUFtQyxZQUFZO0FBQzNDLFFBQUlFLFNBQUosRUFBZTtBQUNYRyxNQUFBQSxZQUFZLENBQUNILFNBQUQsQ0FBWjtBQUNBQSxNQUFBQSxTQUFTLEdBQUcsSUFBWjtBQUNIOztBQUVEWCxJQUFBQSxRQUFRLENBQUMsSUFBRCxFQUFPTixJQUFQLENBQVI7QUFDSCxHQVBELEVBT0csWUFBWTtBQUNYUCxJQUFBQSxFQUFFLENBQUNDLE1BQUgsQ0FBVSxJQUFWLEVBQWdCTSxJQUFoQjtBQUNBTSxJQUFBQSxRQUFRLENBQUMsSUFBRCxFQUFPTixJQUFQLENBQVI7QUFDSCxHQVZEO0FBV0g7O0FBRUQsSUFBSXFCLFVBQVUsR0FBRztBQUNiQyxFQUFBQSxRQUFRLEVBQUUsa0JBQVVDLEdBQVYsRUFBZUMsT0FBZixFQUF3QjdCLFVBQXhCLEVBQW9DO0FBQzFDLFFBQUlKLGNBQWMsR0FBRzhCLFVBQVUsQ0FBQ0ksY0FBWCxDQUEwQkYsR0FBMUIsQ0FBckIsQ0FEMEMsQ0FHMUM7OztBQUNBLFFBQUkxRCxVQUFVLENBQUMwQixjQUFELENBQWQsRUFBZ0M7QUFDNUIsYUFBT0ksVUFBVSxDQUFDLElBQUQsRUFBT0osY0FBUCxDQUFqQjtBQUNIOztBQUVELFFBQUksQ0FBQzVCLGNBQUwsRUFBcUI7QUFDakIsVUFBSStELFdBQVcsR0FBR2QsUUFBUSxDQUFDZSxhQUFULENBQXVCLFFBQXZCLENBQWxCO0FBQ0FELE1BQUFBLFdBQVcsQ0FBQ0UsS0FBWixHQUFvQixHQUFwQjtBQUNBRixNQUFBQSxXQUFXLENBQUNHLE1BQVosR0FBcUIsR0FBckI7QUFDQWxFLE1BQUFBLGNBQWMsR0FBRytELFdBQVcsQ0FBQ0ksVUFBWixDQUF1QixJQUF2QixDQUFqQjtBQUNILEtBYnlDLENBZTFDOzs7QUFDQSxRQUFJL0IsUUFBUSxHQUFHLFVBQVVSLGNBQXpCO0FBQ0E1QixJQUFBQSxjQUFjLENBQUNxQyxJQUFmLEdBQXNCRCxRQUF0QjtBQUNBLFFBQUlELFFBQVEsR0FBR3JDLFNBQVMsQ0FBQ3lDLGVBQVYsQ0FBMEJ2QyxjQUExQixFQUEwQ0MsV0FBMUMsRUFBdURtQyxRQUF2RCxDQUFmLENBbEIwQyxDQW9CMUM7O0FBQ0EsUUFBSWdDLFNBQVMsR0FBR25CLFFBQVEsQ0FBQ2UsYUFBVCxDQUF1QixPQUF2QixDQUFoQjtBQUNBSSxJQUFBQSxTQUFTLENBQUNDLElBQVYsR0FBaUIsVUFBakI7QUFDQSxRQUFJQyxPQUFPLEdBQUcsRUFBZDtBQUNBLFFBQUlDLEtBQUssQ0FBQzNDLGNBQWMsR0FBRyxDQUFsQixDQUFULEVBQ0kwQyxPQUFPLElBQUksOEJBQThCMUMsY0FBOUIsR0FBK0MsUUFBMUQsQ0FESixLQUdJMEMsT0FBTyxJQUFJLCtCQUErQjFDLGNBQS9CLEdBQWdELFNBQTNEO0FBQ0owQyxJQUFBQSxPQUFPLElBQUksVUFBVVYsR0FBVixHQUFnQixLQUEzQjtBQUNBUSxJQUFBQSxTQUFTLENBQUNJLFdBQVYsR0FBd0JGLE9BQU8sR0FBRyxHQUFsQztBQUNBckIsSUFBQUEsUUFBUSxDQUFDd0IsSUFBVCxDQUFjQyxXQUFkLENBQTBCTixTQUExQixFQTlCMEMsQ0FnQzFDOztBQUNBLFFBQUlPLFVBQVUsR0FBRzFCLFFBQVEsQ0FBQ2UsYUFBVCxDQUF1QixLQUF2QixDQUFqQjtBQUNBLFFBQUlZLFFBQVEsR0FBR0QsVUFBVSxDQUFDRSxLQUExQjtBQUNBRCxJQUFBQSxRQUFRLENBQUNqRCxVQUFULEdBQXNCQyxjQUF0QjtBQUNBK0MsSUFBQUEsVUFBVSxDQUFDRyxTQUFYLEdBQXVCLEdBQXZCO0FBQ0FGLElBQUFBLFFBQVEsQ0FBQ0csUUFBVCxHQUFvQixVQUFwQjtBQUNBSCxJQUFBQSxRQUFRLENBQUNJLElBQVQsR0FBZ0IsUUFBaEI7QUFDQUosSUFBQUEsUUFBUSxDQUFDSyxHQUFULEdBQWUsUUFBZjtBQUNBaEMsSUFBQUEsUUFBUSxDQUFDd0IsSUFBVCxDQUFjQyxXQUFkLENBQTBCQyxVQUExQjs7QUFFQSxRQUFJbkUsY0FBYyxFQUFsQixFQUFzQjtBQUNsQmlDLE1BQUFBLHFCQUFxQixDQUFDbEIsSUFBSSxDQUFDRCxHQUFMLEVBQUQsRUFBYU0sY0FBYixFQUE2QkksVUFBN0IsQ0FBckI7QUFDSCxLQUZELE1BR0s7QUFDRDtBQUNBLFVBQUlOLGNBQWMsR0FBRztBQUNqQkUsUUFBQUEsY0FBYyxFQUFkQSxjQURpQjtBQUVqQk8sUUFBQUEsUUFBUSxFQUFSQSxRQUZpQjtBQUdqQkgsUUFBQUEsVUFBVSxFQUFWQSxVQUhpQjtBQUlqQkgsUUFBQUEsU0FBUyxFQUFFTixJQUFJLENBQUNELEdBQUw7QUFKTSxPQUFyQjs7QUFNQWhCLE1BQUFBLGFBQWEsQ0FBQzRFLElBQWQsQ0FBbUJ4RCxjQUFuQjs7QUFDQSxVQUFJckIsV0FBVyxLQUFLLENBQUMsQ0FBckIsRUFBd0I7QUFDcEJBLFFBQUFBLFdBQVcsR0FBRzhFLFdBQVcsQ0FBQy9ELGdCQUFELEVBQW1CLEdBQW5CLENBQXpCO0FBQ0g7QUFDSjs7QUFDRGxCLElBQUFBLFVBQVUsQ0FBQzBCLGNBQUQsQ0FBVixHQUE2QndDLFNBQTdCO0FBQ0gsR0E1RFk7QUE4RGJOLEVBQUFBLGNBQWMsRUFBRSx3QkFBVXNCLFVBQVYsRUFBc0I7QUFDbEMsUUFBSUMsUUFBUSxHQUFHRCxVQUFVLENBQUNFLFdBQVgsQ0FBdUIsTUFBdkIsQ0FBZjtBQUNBLFFBQUlELFFBQVEsS0FBSyxDQUFDLENBQWxCLEVBQXFCLE9BQU9ELFVBQVA7QUFFckIsUUFBSUcsUUFBUSxHQUFHSCxVQUFVLENBQUNFLFdBQVgsQ0FBdUIsR0FBdkIsQ0FBZjtBQUNBLFFBQUkxRCxjQUFKOztBQUNBLFFBQUkyRCxRQUFRLEtBQUssQ0FBQyxDQUFsQixFQUFxQjtBQUNqQjNELE1BQUFBLGNBQWMsR0FBR3dELFVBQVUsQ0FBQ0ksU0FBWCxDQUFxQixDQUFyQixFQUF3QkgsUUFBeEIsSUFBb0MsUUFBckQ7QUFDSCxLQUZELE1BRU87QUFDSHpELE1BQUFBLGNBQWMsR0FBR3dELFVBQVUsQ0FBQ0ksU0FBWCxDQUFxQkQsUUFBUSxHQUFHLENBQWhDLEVBQW1DRixRQUFuQyxJQUErQyxRQUFoRTtBQUNIOztBQUNELFFBQUl6RCxjQUFjLENBQUM2RCxPQUFmLENBQXVCLEdBQXZCLE1BQWdDLENBQUMsQ0FBckMsRUFBd0M7QUFDcEM3RCxNQUFBQSxjQUFjLEdBQUcsTUFBTUEsY0FBTixHQUF1QixHQUF4QztBQUNIOztBQUNELFdBQU9BLGNBQVA7QUFDSDtBQTdFWSxDQUFqQjtBQWdGQThELE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpDLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTkgWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXG5cbiBodHRwczovL3d3dy5jb2Nvcy5jb20vXG5cbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXG4gIHdvcmxkd2lkZSwgcm95YWx0eS1mcmVlLCBub24tYXNzaWduYWJsZSwgcmV2b2NhYmxlIGFuZCBub24tZXhjbHVzaXZlIGxpY2Vuc2VcbiB0byB1c2UgQ29jb3MgQ3JlYXRvciBzb2xlbHkgdG8gZGV2ZWxvcCBnYW1lcyBvbiB5b3VyIHRhcmdldCBwbGF0Zm9ybXMuIFlvdSBzaGFsbFxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXG4gIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcbiAgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIENvY29zIENyZWF0b3IuXG5cbiBUaGUgc29mdHdhcmUgb3IgdG9vbHMgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBhcmUgbGljZW5zZWQsIG5vdCBzb2xkLlxuIFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLiByZXNlcnZlcyBhbGwgcmlnaHRzIG5vdCBleHByZXNzbHkgZ3JhbnRlZCB0byB5b3UuXG5cbiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuIFRIRSBTT0ZUV0FSRS5cbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuXG5jb25zdCB0ZXh0VXRpbHMgPSByZXF1aXJlKCcuLi91dGlscy90ZXh0LXV0aWxzJyk7XG5cbmxldCBfY2FudmFzQ29udGV4dCA9IG51bGw7XG4vLyBsZXR0ZXIgc3ltYm9sIG51bWJlciBDSktcbmxldCBfdGVzdFN0cmluZyA9IFwiQkVTIGJzd3k6LT5AMTIzXFx1NEUwMVxcdTMwNDFcXHUxMTAxXCI7XG5cbmxldCBfZm9udEZhY2VzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbmxldCBfaW50ZXJ2YWxJZCA9IC0xO1xubGV0IF9sb2FkaW5nRm9udHMgPSBbXTtcbi8vIDMgc2Vjb25kcyB0aW1lb3V0XG5sZXQgX3RpbWVvdXQgPSAzMDAwO1xuXG4vLyBSZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vdHlwZWtpdC93ZWJmb250bG9hZGVyL2Jsb2IvbWFzdGVyL3NyYy9jb3JlL2ZvbnR3YXRjaGVyLmpzXG5sZXQgdXNlTmF0aXZlQ2hlY2sgPSAoZnVuY3Rpb24gKCkge1xuICAgIHZhciBuYXRpdmVDaGVjayA9IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAobmF0aXZlQ2hlY2sgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKCEhd2luZG93LkZvbnRGYWNlKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gL0dlY2tvLipGaXJlZm94XFwvKFxcZCspLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTtcbiAgICAgICAgICAgICAgICB2YXIgc2FmYXJpMTBNYXRjaCA9IC9PUyBYLipWZXJzaW9uXFwvMTBcXC4uKlNhZmFyaS8uZXhlYyh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkgJiYgL0FwcGxlLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudmVuZG9yKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gcGFyc2VJbnQobWF0Y2hbMV0sIDEwKSA+IDQyO1xuICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2FmYXJpMTBNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBuYXRpdmVDaGVjayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuYXRpdmVDaGVjayA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5hdGl2ZUNoZWNrO1xuICAgICAgICBcbiAgICB9XG59KSgpO1xuXG5mdW5jdGlvbiBfY2hlY2tGb250TG9hZGVkICgpIHtcbiAgICBsZXQgYWxsRm9udHNMb2FkZWQgPSB0cnVlO1xuICAgIGxldCBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgZm9yIChsZXQgaSA9IF9sb2FkaW5nRm9udHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgbGV0IGZvbnRMb2FkSGFuZGxlID0gX2xvYWRpbmdGb250c1tpXTtcbiAgICAgICAgbGV0IGZvbnRGYW1pbHkgPSBmb250TG9hZEhhbmRsZS5mb250RmFtaWx5TmFtZTtcbiAgICAgICAgLy8gbG9hZCB0aW1lb3V0XG4gICAgICAgIGlmIChub3cgLSBmb250TG9hZEhhbmRsZS5zdGFydFRpbWUgPiBfdGltZW91dCkge1xuICAgICAgICAgICAgY2Mud2FybklEKDQ5MzMsIGZvbnRGYW1pbHkpO1xuICAgICAgICAgICAgZm9udExvYWRIYW5kbGUub25Db21wbGV0ZShudWxsLCBmb250RmFtaWx5KTtcbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgb2xkV2lkdGggPSBmb250TG9hZEhhbmRsZS5yZWZXaWR0aDtcbiAgICAgICAgbGV0IGZvbnREZXNjID0gJzQwcHggJyArIGZvbnRGYW1pbHk7XG4gICAgICAgIF9jYW52YXNDb250ZXh0LmZvbnQgPSBmb250RGVzYztcbiAgICAgICAgbGV0IG5ld1dpZHRoID0gdGV4dFV0aWxzLnNhZmVNZWFzdXJlVGV4dChfY2FudmFzQ29udGV4dCwgX3Rlc3RTdHJpbmcsIGZvbnREZXNjKTtcbiAgICAgICAgLy8gbG9hZGVkIHN1Y2Nlc3NmdWxseVxuICAgICAgICBpZiAob2xkV2lkdGggIT09IG5ld1dpZHRoKSB7XG4gICAgICAgICAgICBfbG9hZGluZ0ZvbnRzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIGZvbnRMb2FkSGFuZGxlLm9uQ29tcGxldGUobnVsbCwgZm9udEZhbWlseSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBhbGxGb250c0xvYWRlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGFsbEZvbnRzTG9hZGVkKSB7XG4gICAgICAgIGNsZWFySW50ZXJ2YWwoX2ludGVydmFsSWQpO1xuICAgICAgICBfaW50ZXJ2YWxJZCA9IC0xO1xuICAgIH1cbn1cblxuLy8gcmVmZXIgdG8gaHR0cHM6Ly9naXRodWIuY29tL3R5cGVraXQvd2ViZm9udGxvYWRlci9ibG9iL21hc3Rlci9zcmMvY29yZS9uYXRpdmVmb250d2F0Y2hydW5uZXIuanNcbmZ1bmN0aW9uIG5hdGl2ZUNoZWNrRm9udExvYWRlZCAoc3RhcnQsIGZvbnQsIGNhbGxiYWNrKSB7XG4gICAgdmFyIGxvYWRlciA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdmFyIGNoZWNrID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7XG5cbiAgICAgICAgICAgIGlmIChub3cgLSBzdGFydCA+PSBfdGltZW91dCkge1xuICAgICAgICAgICAgICAgIHJlamVjdCgpO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmZvbnRzLmxvYWQoJzQwcHggJyArIGZvbnQpLnRoZW4oZnVuY3Rpb24gKGZvbnRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmb250cy5sZW5ndGggPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoY2hlY2ssIDEwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGNoZWNrKCk7XG4gICAgfSk7XG4gIFxuICAgIHZhciB0aW1lb3V0SWQgPSBudWxsLFxuICAgIHRpbWVyID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KHJlamVjdCwgX3RpbWVvdXQpO1xuICAgIH0pO1xuICBcbiAgICBQcm9taXNlLnJhY2UoW3RpbWVyLCBsb2FkZXJdKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRpbWVvdXRJZCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICAgICAgICB0aW1lb3V0SWQgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjYWxsYmFjayhudWxsLCBmb250KTtcbiAgICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNjLndhcm5JRCg0OTMzLCBmb250KTtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgZm9udCk7XG4gICAgfSk7XG59XG5cbnZhciBmb250TG9hZGVyID0ge1xuICAgIGxvYWRGb250OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zLCBvbkNvbXBsZXRlKSB7XG4gICAgICAgIGxldCBmb250RmFtaWx5TmFtZSA9IGZvbnRMb2FkZXIuX2dldEZvbnRGYW1pbHkodXJsKTtcblxuICAgICAgICAvLyBBbHJlYWR5IGxvYWRlZCBmb250c1xuICAgICAgICBpZiAoX2ZvbnRGYWNlc1tmb250RmFtaWx5TmFtZV0pIHtcbiAgICAgICAgICAgIHJldHVybiBvbkNvbXBsZXRlKG51bGwsIGZvbnRGYW1pbHlOYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghX2NhbnZhc0NvbnRleHQpIHtcbiAgICAgICAgICAgIGxldCBsYWJlbENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICAgICAgbGFiZWxDYW52YXMud2lkdGggPSAxMDA7XG4gICAgICAgICAgICBsYWJlbENhbnZhcy5oZWlnaHQgPSAxMDA7XG4gICAgICAgICAgICBfY2FudmFzQ29udGV4dCA9IGxhYmVsQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIERlZmF1bHQgd2lkdGggcmVmZXJlbmNlIHRvIHRlc3Qgd2hldGhlciBuZXcgZm9udCBpcyBsb2FkZWQgY29ycmVjdGx5XG4gICAgICAgIGxldCBmb250RGVzYyA9ICc0MHB4ICcgKyBmb250RmFtaWx5TmFtZTtcbiAgICAgICAgX2NhbnZhc0NvbnRleHQuZm9udCA9IGZvbnREZXNjO1xuICAgICAgICBsZXQgcmVmV2lkdGggPSB0ZXh0VXRpbHMuc2FmZU1lYXN1cmVUZXh0KF9jYW52YXNDb250ZXh0LCBfdGVzdFN0cmluZywgZm9udERlc2MpO1xuXG4gICAgICAgIC8vIFNldHVwIGZvbnQgZmFjZSBzdHlsZVxuICAgICAgICBsZXQgZm9udFN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInN0eWxlXCIpO1xuICAgICAgICBmb250U3R5bGUudHlwZSA9IFwidGV4dC9jc3NcIjtcbiAgICAgICAgbGV0IGZvbnRTdHIgPSBcIlwiO1xuICAgICAgICBpZiAoaXNOYU4oZm9udEZhbWlseU5hbWUgLSAwKSlcbiAgICAgICAgICAgIGZvbnRTdHIgKz0gXCJAZm9udC1mYWNlIHsgZm9udC1mYW1pbHk6XCIgKyBmb250RmFtaWx5TmFtZSArIFwiOyBzcmM6XCI7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGZvbnRTdHIgKz0gXCJAZm9udC1mYWNlIHsgZm9udC1mYW1pbHk6J1wiICsgZm9udEZhbWlseU5hbWUgKyBcIic7IHNyYzpcIjtcbiAgICAgICAgZm9udFN0ciArPSBcInVybCgnXCIgKyB1cmwgKyBcIicpO1wiO1xuICAgICAgICBmb250U3R5bGUudGV4dENvbnRlbnQgPSBmb250U3RyICsgXCJ9XCI7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9udFN0eWxlKTtcblxuICAgICAgICAvLyBQcmVsb2FkIGZvbnQgd2l0aCBkaXZcbiAgICAgICAgbGV0IHByZWxvYWREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICBsZXQgZGl2U3R5bGUgPSBwcmVsb2FkRGl2LnN0eWxlO1xuICAgICAgICBkaXZTdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseU5hbWU7XG4gICAgICAgIHByZWxvYWREaXYuaW5uZXJIVE1MID0gXCIuXCI7XG4gICAgICAgIGRpdlN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xuICAgICAgICBkaXZTdHlsZS5sZWZ0ID0gXCItMTAwcHhcIjtcbiAgICAgICAgZGl2U3R5bGUudG9wID0gXCItMTAwcHhcIjtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChwcmVsb2FkRGl2KTtcblxuICAgICAgICBpZiAodXNlTmF0aXZlQ2hlY2soKSkge1xuICAgICAgICAgICAgbmF0aXZlQ2hlY2tGb250TG9hZGVkKERhdGUubm93KCksIGZvbnRGYW1pbHlOYW1lLCBvbkNvbXBsZXRlKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIFNhdmUgbG9hZGluZyBmb250XG4gICAgICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSB7XG4gICAgICAgICAgICAgICAgZm9udEZhbWlseU5hbWUsXG4gICAgICAgICAgICAgICAgcmVmV2lkdGgsXG4gICAgICAgICAgICAgICAgb25Db21wbGV0ZSxcbiAgICAgICAgICAgICAgICBzdGFydFRpbWU6IERhdGUubm93KClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMucHVzaChmb250TG9hZEhhbmRsZSk7XG4gICAgICAgICAgICBpZiAoX2ludGVydmFsSWQgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgX2ludGVydmFsSWQgPSBzZXRJbnRlcnZhbChfY2hlY2tGb250TG9hZGVkLCAxMDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIF9mb250RmFjZXNbZm9udEZhbWlseU5hbWVdID0gZm9udFN0eWxlO1xuICAgIH0sXG5cbiAgICBfZ2V0Rm9udEZhbWlseTogZnVuY3Rpb24gKGZvbnRIYW5kbGUpIHtcbiAgICAgICAgdmFyIHR0ZkluZGV4ID0gZm9udEhhbmRsZS5sYXN0SW5kZXhPZihcIi50dGZcIik7XG4gICAgICAgIGlmICh0dGZJbmRleCA9PT0gLTEpIHJldHVybiBmb250SGFuZGxlO1xuXG4gICAgICAgIHZhciBzbGFzaFBvcyA9IGZvbnRIYW5kbGUubGFzdEluZGV4T2YoXCIvXCIpO1xuICAgICAgICB2YXIgZm9udEZhbWlseU5hbWU7XG4gICAgICAgIGlmIChzbGFzaFBvcyA9PT0gLTEpIHtcbiAgICAgICAgICAgIGZvbnRGYW1pbHlOYW1lID0gZm9udEhhbmRsZS5zdWJzdHJpbmcoMCwgdHRmSW5kZXgpICsgXCJfTEFCRUxcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvbnRGYW1pbHlOYW1lID0gZm9udEhhbmRsZS5zdWJzdHJpbmcoc2xhc2hQb3MgKyAxLCB0dGZJbmRleCkgKyBcIl9MQUJFTFwiO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmb250RmFtaWx5TmFtZS5pbmRleE9mKCcgJykgIT09IC0xKSB7XG4gICAgICAgICAgICBmb250RmFtaWx5TmFtZSA9ICdcIicgKyBmb250RmFtaWx5TmFtZSArICdcIic7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvbnRGYW1pbHlOYW1lO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gZm9udExvYWRlciJdLCJzb3VyY2VSb290IjoiLyJ9