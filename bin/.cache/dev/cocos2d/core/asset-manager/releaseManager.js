
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/releaseManager.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var dependUtil = require('./depend-util');

var Cache = require('./cache');

require('../assets/CCAsset');

var _require = require('./shared'),
    assets = _require.assets;

var _require2 = require('../platform/utils'),
    callInNextTick = _require2.callInNextTick;

function visitAsset(asset, deps) {
  // Skip assets generated programmatically or by user (e.g. label texture)
  if (!asset._uuid) {
    return;
  }

  deps.push(asset._uuid);
}

function visitComponent(comp, deps) {
  var props = Object.getOwnPropertyNames(comp);

  for (var i = 0; i < props.length; i++) {
    var propName = props[i];
    if (propName === 'node' || propName === '__eventTargets') continue;
    var value = comp[propName];

    if (typeof value === 'object' && value) {
      if (Array.isArray(value)) {
        for (var j = 0; j < value.length; j++) {
          var val = value[j];

          if (val instanceof cc.Asset) {
            visitAsset(val, deps);
          }
        }
      } else if (!value.constructor || value.constructor === Object) {
        var keys = Object.getOwnPropertyNames(value);

        for (var _j = 0; _j < keys.length; _j++) {
          var _val = value[keys[_j]];

          if (_val instanceof cc.Asset) {
            visitAsset(_val, deps);
          }
        }
      } else if (value instanceof cc.Asset) {
        visitAsset(value, deps);
      }
    }
  }
}

var _temp = [];

function visitNode(node, deps) {
  for (var i = 0; i < node._components.length; i++) {
    visitComponent(node._components[i], deps);
  }

  for (var _i = 0; _i < node._children.length; _i++) {
    visitNode(node._children[_i], deps);
  }
}

function descendOpRef(asset, refs, exclude, op) {
  exclude.push(asset._uuid);
  var depends = dependUtil.getDeps(asset._uuid);

  for (var i = 0, l = depends.length; i < l; i++) {
    var dependAsset = assets.get(depends[i]);

    if (dependAsset) {
      var uuid = dependAsset._uuid;

      if (!(uuid in refs)) {
        refs[uuid] = dependAsset.refCount + op;
      } else {
        refs[uuid] += op;
      }

      if (exclude.includes(uuid)) continue;
      descendOpRef(dependAsset, refs, exclude, op);
    }
  }
}

function checkCircularReference(asset) {
  // check circular reference
  var refs = Object.create(null);
  refs[asset._uuid] = asset.refCount;
  descendOpRef(asset, refs, _temp, -1);
  _temp.length = 0;
  if (refs[asset._uuid] !== 0) return refs[asset._uuid];

  for (var uuid in refs) {
    if (refs[uuid] !== 0) {
      descendOpRef(assets.get(uuid), refs, _temp, 1);
    }
  }

  _temp.length = 0;
  return refs[asset._uuid];
}

var _persistNodeDeps = new Cache();

var _toDelete = new Cache();

var eventListener = false;

function freeAssets() {
  eventListener = false;

  _toDelete.forEach(function (asset) {
    releaseManager._free(asset);
  });

  _toDelete.clear();
}

var releaseManager = {
  init: function init() {
    _persistNodeDeps.clear();

    _toDelete.clear();
  },
  _addPersistNodeRef: function _addPersistNodeRef(node) {
    var deps = [];
    visitNode(node, deps);

    for (var i = 0, l = deps.length; i < l; i++) {
      var dependAsset = assets.get(deps[i]);

      if (dependAsset) {
        dependAsset.addRef();
      }
    }

    _persistNodeDeps.add(node.uuid, deps);
  },
  _removePersistNodeRef: function _removePersistNodeRef(node) {
    if (_persistNodeDeps.has(node.uuid)) {
      var deps = _persistNodeDeps.get(node.uuid);

      for (var i = 0, l = deps.length; i < l; i++) {
        var dependAsset = assets.get(deps[i]);

        if (dependAsset) {
          dependAsset.decRef();
        }
      }

      _persistNodeDeps.remove(node.uuid);
    }
  },
  // do auto release
  _autoRelease: function _autoRelease(oldScene, newScene, persistNodes) {
    if (oldScene) {
      var childs = dependUtil.getDeps(oldScene._id);

      for (var i = 0, l = childs.length; i < l; i++) {
        var asset = assets.get(childs[i]);
        asset && asset.decRef(CC_TEST || oldScene.autoReleaseAssets);
      }

      var dependencies = dependUtil._depends.get(oldScene._id);

      if (dependencies && dependencies.persistDeps) {
        var persistDeps = dependencies.persistDeps;

        for (var _i2 = 0, _l = persistDeps.length; _i2 < _l; _i2++) {
          var _asset = assets.get(persistDeps[_i2]);

          _asset && _asset.decRef(CC_TEST || oldScene.autoReleaseAssets);
        }
      }

      oldScene._id !== newScene._id && dependUtil.remove(oldScene._id);
    }

    var sceneDeps = dependUtil._depends.get(newScene._id);

    sceneDeps && (sceneDeps.persistDeps = []); // transfer refs from persist nodes to new scene

    for (var key in persistNodes) {
      var node = persistNodes[key];

      var deps = _persistNodeDeps.get(node.uuid);

      for (var _i3 = 0, _l2 = deps.length; _i3 < _l2; _i3++) {
        var dependAsset = assets.get(deps[_i3]);

        if (dependAsset) {
          dependAsset.addRef();
        }
      }

      if (sceneDeps) {
        sceneDeps.persistDeps.push.apply(sceneDeps.persistDeps, deps);
      }
    }
  },
  _free: function _free(asset, force) {
    _toDelete.remove(asset._uuid);

    if (!cc.isValid(asset, true)) return;

    if (!force) {
      if (asset.refCount > 0) {
        if (checkCircularReference(asset) > 0) return;
      }
    } // remove from cache


    assets.remove(asset._uuid);
    var depends = dependUtil.getDeps(asset._uuid);

    for (var i = 0, l = depends.length; i < l; i++) {
      var dependAsset = assets.get(depends[i]);

      if (dependAsset) {
        dependAsset.decRef(false);

        releaseManager._free(dependAsset, false);
      }
    }

    asset.destroy();
    dependUtil.remove(asset._uuid);
  },
  tryRelease: function tryRelease(asset, force) {
    if (!(asset instanceof cc.Asset)) return;

    if (force) {
      releaseManager._free(asset, force);
    } else {
      _toDelete.add(asset._uuid, asset);

      if (!eventListener) {
        eventListener = true;
        callInNextTick(freeAssets);
      }
    }
  }
};
module.exports = releaseManager;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL2Fzc2V0LW1hbmFnZXIvcmVsZWFzZU1hbmFnZXIuanMiXSwibmFtZXMiOlsiZGVwZW5kVXRpbCIsInJlcXVpcmUiLCJDYWNoZSIsImFzc2V0cyIsImNhbGxJbk5leHRUaWNrIiwidmlzaXRBc3NldCIsImFzc2V0IiwiZGVwcyIsIl91dWlkIiwicHVzaCIsInZpc2l0Q29tcG9uZW50IiwiY29tcCIsInByb3BzIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImkiLCJsZW5ndGgiLCJwcm9wTmFtZSIsInZhbHVlIiwiQXJyYXkiLCJpc0FycmF5IiwiaiIsInZhbCIsImNjIiwiQXNzZXQiLCJjb25zdHJ1Y3RvciIsImtleXMiLCJfdGVtcCIsInZpc2l0Tm9kZSIsIm5vZGUiLCJfY29tcG9uZW50cyIsIl9jaGlsZHJlbiIsImRlc2NlbmRPcFJlZiIsInJlZnMiLCJleGNsdWRlIiwib3AiLCJkZXBlbmRzIiwiZ2V0RGVwcyIsImwiLCJkZXBlbmRBc3NldCIsImdldCIsInV1aWQiLCJyZWZDb3VudCIsImluY2x1ZGVzIiwiY2hlY2tDaXJjdWxhclJlZmVyZW5jZSIsImNyZWF0ZSIsIl9wZXJzaXN0Tm9kZURlcHMiLCJfdG9EZWxldGUiLCJldmVudExpc3RlbmVyIiwiZnJlZUFzc2V0cyIsImZvckVhY2giLCJyZWxlYXNlTWFuYWdlciIsIl9mcmVlIiwiY2xlYXIiLCJpbml0IiwiX2FkZFBlcnNpc3ROb2RlUmVmIiwiYWRkUmVmIiwiYWRkIiwiX3JlbW92ZVBlcnNpc3ROb2RlUmVmIiwiaGFzIiwiZGVjUmVmIiwicmVtb3ZlIiwiX2F1dG9SZWxlYXNlIiwib2xkU2NlbmUiLCJuZXdTY2VuZSIsInBlcnNpc3ROb2RlcyIsImNoaWxkcyIsIl9pZCIsIkNDX1RFU1QiLCJhdXRvUmVsZWFzZUFzc2V0cyIsImRlcGVuZGVuY2llcyIsIl9kZXBlbmRzIiwicGVyc2lzdERlcHMiLCJzY2VuZURlcHMiLCJrZXkiLCJhcHBs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R0FBaUI5QixjQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gQ29weXJpZ2h0IChjKSAyMDE5IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxuXG4gaHR0cHM6Ly93d3cuY29jb3MuY29tL1xuXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZW5naW5lIHNvdXJjZSBjb2RlICh0aGUgXCJTb2Z0d2FyZVwiKSwgYSBsaW1pdGVkLFxuICB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcbiAgbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xuICB1c2VkIGZvciBkZXZlbG9waW5nIGdhbWVzLiBZb3UgYXJlIG5vdCBncmFudGVkIHRvIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxuXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbiBUSEUgU09GVFdBUkUuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbmNvbnN0IGRlcGVuZFV0aWwgPSByZXF1aXJlKCcuL2RlcGVuZC11dGlsJyk7XG5jb25zdCBDYWNoZSA9IHJlcXVpcmUoJy4vY2FjaGUnKTtcbnJlcXVpcmUoJy4uL2Fzc2V0cy9DQ0Fzc2V0Jyk7XG5jb25zdCB7IGFzc2V0cyB9ID0gcmVxdWlyZSgnLi9zaGFyZWQnKTtcbmNvbnN0IHsgY2FsbEluTmV4dFRpY2sgfSA9IHJlcXVpcmUoJy4uL3BsYXRmb3JtL3V0aWxzJyk7XG5cbmZ1bmN0aW9uIHZpc2l0QXNzZXQgKGFzc2V0LCBkZXBzKSB7XG4gICAgLy8gU2tpcCBhc3NldHMgZ2VuZXJhdGVkIHByb2dyYW1tYXRpY2FsbHkgb3IgYnkgdXNlciAoZS5nLiBsYWJlbCB0ZXh0dXJlKVxuICAgIGlmICghYXNzZXQuX3V1aWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZXBzLnB1c2goYXNzZXQuX3V1aWQpO1xufVxuXG5mdW5jdGlvbiB2aXNpdENvbXBvbmVudCAoY29tcCwgZGVwcykge1xuICAgIHZhciBwcm9wcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGNvbXApO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdmFyIHByb3BOYW1lID0gcHJvcHNbaV07XG4gICAgICAgIGlmIChwcm9wTmFtZSA9PT0gJ25vZGUnIHx8IHByb3BOYW1lID09PSAnX19ldmVudFRhcmdldHMnKSBjb250aW51ZTtcbiAgICAgICAgdmFyIHZhbHVlID0gY29tcFtwcm9wTmFtZV07XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHZhbHVlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWwgPSB2YWx1ZVtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCBpbnN0YW5jZW9mIGNjLkFzc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aXNpdEFzc2V0KHZhbCwgZGVwcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICghdmFsdWUuY29uc3RydWN0b3IgfHwgdmFsdWUuY29uc3RydWN0b3IgPT09IE9iamVjdCkge1xuICAgICAgICAgICAgICAgIGxldCBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsdWUpO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwga2V5cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgdmFsID0gdmFsdWVba2V5c1tqXV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWwgaW5zdGFuY2VvZiBjYy5Bc3NldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlzaXRBc3NldCh2YWwsIGRlcHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBjYy5Bc3NldCkge1xuICAgICAgICAgICAgICAgIHZpc2l0QXNzZXQodmFsdWUsIGRlcHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5sZXQgX3RlbXAgPSBbXTtcblxuZnVuY3Rpb24gdmlzaXROb2RlIChub2RlLCBkZXBzKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLl9jb21wb25lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZpc2l0Q29tcG9uZW50KG5vZGUuX2NvbXBvbmVudHNbaV0sIGRlcHMpO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZpc2l0Tm9kZShub2RlLl9jaGlsZHJlbltpXSwgZGVwcyk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBkZXNjZW5kT3BSZWYgKGFzc2V0LCByZWZzLCBleGNsdWRlLCBvcCkge1xuICAgIGV4Y2x1ZGUucHVzaChhc3NldC5fdXVpZCk7XG4gICAgdmFyIGRlcGVuZHMgPSBkZXBlbmRVdGlsLmdldERlcHMoYXNzZXQuX3V1aWQpO1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gZGVwZW5kcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgdmFyIGRlcGVuZEFzc2V0ID0gYXNzZXRzLmdldChkZXBlbmRzW2ldKTtcbiAgICAgICAgaWYgKGRlcGVuZEFzc2V0KSB7XG4gICAgICAgICAgICBsZXQgdXVpZCA9IGRlcGVuZEFzc2V0Ll91dWlkO1xuICAgICAgICAgICAgaWYgKCEodXVpZCBpbiByZWZzKSkgeyBcbiAgICAgICAgICAgICAgICByZWZzW3V1aWRdID0gZGVwZW5kQXNzZXQucmVmQ291bnQgKyBvcDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlZnNbdXVpZF0gKz0gb3A7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZXhjbHVkZS5pbmNsdWRlcyh1dWlkKSkgY29udGludWU7IFxuICAgICAgICAgICAgZGVzY2VuZE9wUmVmKGRlcGVuZEFzc2V0LCByZWZzLCBleGNsdWRlLCBvcCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNoZWNrQ2lyY3VsYXJSZWZlcmVuY2UgKGFzc2V0KSB7XG4gICAgLy8gY2hlY2sgY2lyY3VsYXIgcmVmZXJlbmNlXG4gICAgdmFyIHJlZnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIHJlZnNbYXNzZXQuX3V1aWRdID0gYXNzZXQucmVmQ291bnQ7XG4gICAgZGVzY2VuZE9wUmVmKGFzc2V0LCByZWZzLCBfdGVtcCwgLTEpO1xuICAgIF90ZW1wLmxlbmd0aCA9IDA7XG4gICAgaWYgKHJlZnNbYXNzZXQuX3V1aWRdICE9PSAwKSByZXR1cm4gcmVmc1thc3NldC5fdXVpZF07XG5cbiAgICBmb3IgKGxldCB1dWlkIGluIHJlZnMpIHtcbiAgICAgICAgaWYgKHJlZnNbdXVpZF0gIT09IDApIHtcbiAgICAgICAgICAgIGRlc2NlbmRPcFJlZihhc3NldHMuZ2V0KHV1aWQpLCByZWZzLCBfdGVtcCwgMSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgX3RlbXAubGVuZ3RoID0gMDtcblxuICAgIHJldHVybiByZWZzW2Fzc2V0Ll91dWlkXTtcbn1cblxudmFyIF9wZXJzaXN0Tm9kZURlcHMgPSBuZXcgQ2FjaGUoKTtcbnZhciBfdG9EZWxldGUgPSBuZXcgQ2FjaGUoKTtcbnZhciBldmVudExpc3RlbmVyID0gZmFsc2U7XG5cbmZ1bmN0aW9uIGZyZWVBc3NldHMgKCkge1xuICAgIGV2ZW50TGlzdGVuZXIgPSBmYWxzZTtcbiAgICBfdG9EZWxldGUuZm9yRWFjaChmdW5jdGlvbiAoYXNzZXQpIHtcbiAgICAgICAgcmVsZWFzZU1hbmFnZXIuX2ZyZWUoYXNzZXQpO1xuICAgIH0pO1xuICAgIF90b0RlbGV0ZS5jbGVhcigpO1xufVxuXG52YXIgcmVsZWFzZU1hbmFnZXIgPSB7XG4gICAgaW5pdCAoKSB7XG4gICAgICAgIF9wZXJzaXN0Tm9kZURlcHMuY2xlYXIoKTtcbiAgICAgICAgX3RvRGVsZXRlLmNsZWFyKCk7XG4gICAgfSxcblxuICAgIF9hZGRQZXJzaXN0Tm9kZVJlZiAobm9kZSkge1xuICAgICAgICB2YXIgZGVwcyA9IFtdO1xuICAgICAgICB2aXNpdE5vZGUobm9kZSwgZGVwcyk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZGVwcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBkZXBlbmRBc3NldCA9IGFzc2V0cy5nZXQoZGVwc1tpXSk7XG4gICAgICAgICAgICBpZiAoZGVwZW5kQXNzZXQpIHtcbiAgICAgICAgICAgICAgICBkZXBlbmRBc3NldC5hZGRSZWYoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBfcGVyc2lzdE5vZGVEZXBzLmFkZChub2RlLnV1aWQsIGRlcHMpO1xuICAgIH0sXG5cbiAgICBfcmVtb3ZlUGVyc2lzdE5vZGVSZWYgKG5vZGUpIHtcbiAgICAgICAgaWYgKF9wZXJzaXN0Tm9kZURlcHMuaGFzKG5vZGUudXVpZCkpIHtcbiAgICAgICAgICAgIHZhciBkZXBzID0gX3BlcnNpc3ROb2RlRGVwcy5nZXQobm9kZS51dWlkKTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZGVwcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgZGVwZW5kQXNzZXQgPSBhc3NldHMuZ2V0KGRlcHNbaV0pO1xuICAgICAgICAgICAgICAgIGlmIChkZXBlbmRBc3NldCkge1xuICAgICAgICAgICAgICAgICAgICBkZXBlbmRBc3NldC5kZWNSZWYoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfcGVyc2lzdE5vZGVEZXBzLnJlbW92ZShub2RlLnV1aWQpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8vIGRvIGF1dG8gcmVsZWFzZVxuICAgIF9hdXRvUmVsZWFzZSAob2xkU2NlbmUsIG5ld1NjZW5lLCBwZXJzaXN0Tm9kZXMpIHsgXG5cbiAgICAgICAgaWYgKG9sZFNjZW5lKSB7XG4gICAgICAgICAgICB2YXIgY2hpbGRzID0gZGVwZW5kVXRpbC5nZXREZXBzKG9sZFNjZW5lLl9pZCk7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGNoaWxkcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgYXNzZXQgPSBhc3NldHMuZ2V0KGNoaWxkc1tpXSk7XG4gICAgICAgICAgICAgICAgYXNzZXQgJiYgYXNzZXQuZGVjUmVmKENDX1RFU1QgfHwgb2xkU2NlbmUuYXV0b1JlbGVhc2VBc3NldHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IGRlcGVuZFV0aWwuX2RlcGVuZHMuZ2V0KG9sZFNjZW5lLl9pZCk7XG4gICAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzICYmIGRlcGVuZGVuY2llcy5wZXJzaXN0RGVwcykge1xuICAgICAgICAgICAgICAgIHZhciBwZXJzaXN0RGVwcyA9IGRlcGVuZGVuY2llcy5wZXJzaXN0RGVwcztcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHBlcnNpc3REZXBzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgYXNzZXQgPSBhc3NldHMuZ2V0KHBlcnNpc3REZXBzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQgJiYgYXNzZXQuZGVjUmVmKENDX1RFU1QgfHwgb2xkU2NlbmUuYXV0b1JlbGVhc2VBc3NldHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9sZFNjZW5lLl9pZCAhPT0gbmV3U2NlbmUuX2lkICYmIGRlcGVuZFV0aWwucmVtb3ZlKG9sZFNjZW5lLl9pZCk7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgc2NlbmVEZXBzID0gZGVwZW5kVXRpbC5fZGVwZW5kcy5nZXQobmV3U2NlbmUuX2lkKTtcbiAgICAgICAgc2NlbmVEZXBzICYmIChzY2VuZURlcHMucGVyc2lzdERlcHMgPSBbXSk7XG4gICAgICAgIC8vIHRyYW5zZmVyIHJlZnMgZnJvbSBwZXJzaXN0IG5vZGVzIHRvIG5ldyBzY2VuZVxuICAgICAgICBmb3IgKGxldCBrZXkgaW4gcGVyc2lzdE5vZGVzKSB7XG4gICAgICAgICAgICB2YXIgbm9kZSA9IHBlcnNpc3ROb2Rlc1trZXldO1xuICAgICAgICAgICAgdmFyIGRlcHMgPSBfcGVyc2lzdE5vZGVEZXBzLmdldChub2RlLnV1aWQpO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBkZXBzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBkZXBlbmRBc3NldCA9IGFzc2V0cy5nZXQoZGVwc1tpXSk7XG4gICAgICAgICAgICAgICAgaWYgKGRlcGVuZEFzc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGRlcGVuZEFzc2V0LmFkZFJlZigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzY2VuZURlcHMpIHtcbiAgICAgICAgICAgICAgICBzY2VuZURlcHMucGVyc2lzdERlcHMucHVzaC5hcHBseShzY2VuZURlcHMucGVyc2lzdERlcHMsIGRlcHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9mcmVlIChhc3NldCwgZm9yY2UpIHtcbiAgICAgICAgX3RvRGVsZXRlLnJlbW92ZShhc3NldC5fdXVpZCk7XG5cbiAgICAgICAgaWYgKCFjYy5pc1ZhbGlkKGFzc2V0LCB0cnVlKSkgcmV0dXJuO1xuXG4gICAgICAgIGlmICghZm9yY2UpIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5yZWZDb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hlY2tDaXJjdWxhclJlZmVyZW5jZShhc3NldCkgPiAwKSByZXR1cm47IFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgXG4gICAgICAgIC8vIHJlbW92ZSBmcm9tIGNhY2hlXG4gICAgICAgIGFzc2V0cy5yZW1vdmUoYXNzZXQuX3V1aWQpO1xuICAgICAgICB2YXIgZGVwZW5kcyA9IGRlcGVuZFV0aWwuZ2V0RGVwcyhhc3NldC5fdXVpZCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZGVwZW5kcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBkZXBlbmRBc3NldCA9IGFzc2V0cy5nZXQoZGVwZW5kc1tpXSk7XG4gICAgICAgICAgICBpZiAoZGVwZW5kQXNzZXQpIHtcbiAgICAgICAgICAgICAgICBkZXBlbmRBc3NldC5kZWNSZWYoZmFsc2UpO1xuICAgICAgICAgICAgICAgIHJlbGVhc2VNYW5hZ2VyLl9mcmVlKGRlcGVuZEFzc2V0LCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXNzZXQuZGVzdHJveSgpO1xuICAgICAgICBkZXBlbmRVdGlsLnJlbW92ZShhc3NldC5fdXVpZCk7XG4gICAgfSxcblxuICAgIHRyeVJlbGVhc2UgKGFzc2V0LCBmb3JjZSkge1xuICAgICAgICBpZiAoIShhc3NldCBpbnN0YW5jZW9mIGNjLkFzc2V0KSkgcmV0dXJuO1xuICAgICAgICBpZiAoZm9yY2UpIHtcbiAgICAgICAgICAgIHJlbGVhc2VNYW5hZ2VyLl9mcmVlKGFzc2V0LCBmb3JjZSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBfdG9EZWxldGUuYWRkKGFzc2V0Ll91dWlkLCBhc3NldCk7XG4gICAgICAgICAgICBpZiAoIWV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgICAgICAgICBldmVudExpc3RlbmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjYWxsSW5OZXh0VGljayhmcmVlQXNzZXRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gcmVsZWFzZU1hbmFnZXI7Il0sInNvdXJjZVJvb3QiOiIvIn0=