
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/fetch.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var packManager = require('./pack-manager');

var Task = require('./task');

var _require = require('./utilities'),
    getDepends = _require.getDepends,
    clear = _require.clear,
    forEach = _require.forEach;

var _require2 = require('./shared'),
    assets = _require2.assets,
    fetchPipeline = _require2.fetchPipeline;

function fetch(task, done) {
  var firstTask = false;

  if (!task.progress) {
    task.progress = {
      finish: 0,
      total: task.input.length,
      canInvoke: true
    };
    firstTask = true;
  }

  var options = task.options,
      depends = [],
      progress = task.progress,
      total = progress.total;
  options.__exclude__ = options.__exclude__ || Object.create(null);
  task.output = [];
  forEach(task.input, function (item, cb) {
    if (!item.isNative && assets.has(item.uuid)) {
      var asset = assets.get(item.uuid);
      asset.addRef();
      handle(item, task, asset, null, asset.__asyncLoadAssets__, depends, total, done);
      return cb();
    }

    packManager.load(item, task.options, function (err, data) {
      if (err) {
        if (!task.isFinish) {
          if (!cc.assetManager.force || firstTask) {
            cc.error(err.message, err.stack);
            progress.canInvoke = false;
            done(err);
          } else {
            handle(item, task, null, null, false, depends, total, done);
          }
        }
      } else {
        if (!task.isFinish) handle(item, task, null, data, !item.isNative, depends, total, done);
      }

      cb();
    });
  }, function () {
    if (task.isFinish) {
      clear(task, true);
      return task.dispatch('error');
    }

    if (depends.length > 0) {
      // stage 2 , download depend asset
      var subTask = Task.create({
        name: task.name + ' dependencies',
        input: depends,
        progress: progress,
        options: options,
        onProgress: task.onProgress,
        onError: Task.prototype.recycle,
        onComplete: function onComplete(err) {
          if (!err) {
            task.output.push.apply(task.output, this.output);
            subTask.recycle();
          }

          if (firstTask) decreaseRef(task);
          done(err);
        }
      });
      fetchPipeline.async(subTask);
      return;
    }

    if (firstTask) decreaseRef(task);
    done();
  });
}

function decreaseRef(task) {
  var output = task.output;

  for (var i = 0, l = output.length; i < l; i++) {
    output[i].content && output[i].content.decRef(false);
  }
}

function handle(item, task, content, file, loadDepends, depends, last, done) {
  var exclude = task.options.__exclude__;
  var progress = task.progress;
  item.content = content;
  item.file = file;
  task.output.push(item);

  if (loadDepends) {
    exclude[item.uuid] = true;
    getDepends(item.uuid, file || content, exclude, depends, true, false, item.config);
    progress.total = last + depends.length;
  }

  progress.canInvoke && task.dispatch('progress', ++progress.finish, progress.total, item);
}

module.exports = fetch;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL2Fzc2V0LW1hbmFnZXIvZmV0Y2guanMiXSwibmFtZXMiOlsicGFja01hbmFnZXIiLCJyZXF1aXJlIiwiVGFzayIsImdldERlcGVuZHMiLCJjbGVhciIsImZvckVhY2giLCJhc3NldHMiLCJmZXRjaFBpcGVsaW5lIiwiZmV0Y2giLCJ0YXNrIiwiZG9uZSIsImZpcnN0VGFzayIsInByb2dyZXNzIiwiZmluaXNoIiwidG90YWwiLCJpbnB1dCIsImxlbmd0aCIsImNhbkludm9rZSIsIm9wdGlvbnMiLCJkZXBlbmRzIiwiX19leGNsdWRlX18iLCJPYmplY3QiLCJjcmVhdGUiLCJvdXRwdXQiLCJpdGVtIiwiY2IiLCJpc05hdGl2ZSIsImhhcyIsInV1aWQiLCJhc3NldCIsImdldCIsImFkZFJlZiIsImhhbmRsZSIsIl9fYXN5bmNMb2FkQXNzZXRzX18iLCJsb2FkIiwiZXJyIiwiZGF0YSIsImlzRmluaXNoIiwiY2MiLCJhc3NldE1hbmFnZXIiLCJmb3JjZSIsImVycm9yIiwibWVzc2FnZSIsInN0YWNrIiwiZGlzcGF0Y2giLCJzdWJUYXNrIiwibmFtZSIsIm9uUHJvZ3Jlc3MiLCJvbkVycm9yIiwicHJvdG90eXBlIiwicmVjeWNsZSIsIm9uQ29tcGxldGUiLCJwdXNoIiwiYXBwbHkiLCJkZWNyZWFzZVJlZiIsImFzeW5jIiwiaSIsImwiLCJjb250ZW50IiwiZGVjUmVmIiwiZmlsZSIsImxvYWREZXBlbmRzIiwibGFzdCIsImV4Y2x1ZGUiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsV0FBVyxHQUFHQyxPQUFPLENBQUMsZ0JBQUQsQ0FB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LFVBQVUsQ0FBQ3FCLElBQUksQ0FBQ0ksSUFBTixFQUFZZ0MsSUFBSSxJQUFJRixPQUFwQixFQUE2QkssT0FBN0IsRUFBc0M1QyxPQUF0QyxFQUErQyxJQUEvQyxFQUFxRCxLQUFyRCxFQUE0REssSUFBSSxDQUFDd0MsTUFBakUsQ0FBVjtBQUNBcEQsSUFBQUEsUUFBUSxDQUFDRSxLQUFULEdBQWlCZ0QsSUFBSSxHQUFHM0MsT0FBTyxDQUFDSCxNQUFoQztBQUNIOztBQUVESixFQUFBQSxRQUFRLENBQUNLLFNBQVQsSUFBc0JSLElBQUksQ0FBQ21DLFFBQUwsQ0FBYyxVQUFkLEVBQTBCLEVBQUVoQyxRQUFRLENBQUNDLE1BQXJDLEVBQTZDRCxRQUFRLENBQUNFLEtBQXRELEVBQTZEVSxJQUE3RCxDQUF0QjtBQUNIOztBQUVEeUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCMUQsS0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuIENvcHlyaWdodCAoYykgMjAxOSBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXG4gIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuICBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cblxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cblxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gVEhFIFNPRlRXQVJFLlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5jb25zdCBwYWNrTWFuYWdlciA9IHJlcXVpcmUoJy4vcGFjay1tYW5hZ2VyJyk7XG5jb25zdCBUYXNrID0gcmVxdWlyZSgnLi90YXNrJyk7XG5jb25zdCB7IGdldERlcGVuZHMsIGNsZWFyLCBmb3JFYWNoIH0gPSByZXF1aXJlKCcuL3V0aWxpdGllcycpO1xuY29uc3QgeyBhc3NldHMsIGZldGNoUGlwZWxpbmUgfSA9IHJlcXVpcmUoJy4vc2hhcmVkJyk7XG5cbmZ1bmN0aW9uIGZldGNoICh0YXNrLCBkb25lKSB7XG5cbiAgICBsZXQgZmlyc3RUYXNrID0gZmFsc2U7XG4gICAgaWYgKCF0YXNrLnByb2dyZXNzKSB7XG4gICAgICAgIHRhc2sucHJvZ3Jlc3MgPSB7IGZpbmlzaDogMCwgdG90YWw6IHRhc2suaW5wdXQubGVuZ3RoLCBjYW5JbnZva2U6IHRydWUgfTsgXG4gICAgICAgIGZpcnN0VGFzayA9IHRydWU7XG4gICAgfVxuXG4gICAgbGV0IG9wdGlvbnMgPSB0YXNrLm9wdGlvbnMsIGRlcGVuZHMgPSBbXSwgcHJvZ3Jlc3MgPSB0YXNrLnByb2dyZXNzLCB0b3RhbCA9IHByb2dyZXNzLnRvdGFsO1xuICAgIG9wdGlvbnMuX19leGNsdWRlX18gPSBvcHRpb25zLl9fZXhjbHVkZV9fIHx8IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICB0YXNrLm91dHB1dCA9IFtdO1xuXG4gICAgZm9yRWFjaCh0YXNrLmlucHV0LCBmdW5jdGlvbiAoaXRlbSwgY2IpIHtcbiAgICAgICAgXG4gICAgICAgIGlmICghaXRlbS5pc05hdGl2ZSAmJiBhc3NldHMuaGFzKGl0ZW0udXVpZCkpIHtcbiAgICAgICAgICAgIHZhciBhc3NldCA9IGFzc2V0cy5nZXQoaXRlbS51dWlkKTtcbiAgICAgICAgICAgIGFzc2V0LmFkZFJlZigpO1xuICAgICAgICAgICAgaGFuZGxlKGl0ZW0sIHRhc2ssIGFzc2V0LCBudWxsLCBhc3NldC5fX2FzeW5jTG9hZEFzc2V0c19fLCBkZXBlbmRzLCB0b3RhbCwgZG9uZSk7XG4gICAgICAgICAgICByZXR1cm4gY2IoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBhY2tNYW5hZ2VyLmxvYWQoaXRlbSwgdGFzay5vcHRpb25zLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0YXNrLmlzRmluaXNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY2MuYXNzZXRNYW5hZ2VyLmZvcmNlIHx8IGZpcnN0VGFzaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2MuZXJyb3IoZXJyLm1lc3NhZ2UsIGVyci5zdGFjayk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzcy5jYW5JbnZva2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZShpdGVtLCB0YXNrLCBudWxsLCBudWxsLCBmYWxzZSwgZGVwZW5kcywgdG90YWwsIGRvbmUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0YXNrLmlzRmluaXNoKSBoYW5kbGUoaXRlbSwgdGFzaywgbnVsbCwgZGF0YSwgIWl0ZW0uaXNOYXRpdmUsIGRlcGVuZHMsIHRvdGFsLCBkb25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNiKCk7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICB9LCBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgaWYgKHRhc2suaXNGaW5pc2gpIHtcbiAgICAgICAgICAgIGNsZWFyKHRhc2ssIHRydWUpO1xuICAgICAgICAgICAgcmV0dXJuIHRhc2suZGlzcGF0Y2goJ2Vycm9yJyk7XG4gICAgICAgIH0gXG4gICAgICAgIGlmIChkZXBlbmRzLmxlbmd0aCA+IDApIHtcblxuICAgICAgICAgICAgLy8gc3RhZ2UgMiAsIGRvd25sb2FkIGRlcGVuZCBhc3NldFxuICAgICAgICAgICAgbGV0IHN1YlRhc2sgPSBUYXNrLmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgbmFtZTogdGFzay5uYW1lICsgJyBkZXBlbmRlbmNpZXMnLFxuICAgICAgICAgICAgICAgIGlucHV0OiBkZXBlbmRzLFxuICAgICAgICAgICAgICAgIHByb2dyZXNzLFxuICAgICAgICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgICAgICAgb25Qcm9ncmVzczogdGFzay5vblByb2dyZXNzLFxuICAgICAgICAgICAgICAgIG9uRXJyb3I6IFRhc2sucHJvdG90eXBlLnJlY3ljbGUsXG4gICAgICAgICAgICAgICAgb25Db21wbGV0ZTogZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5vdXRwdXQucHVzaC5hcHBseSh0YXNrLm91dHB1dCwgdGhpcy5vdXRwdXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViVGFzay5yZWN5Y2xlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0VGFzaykgZGVjcmVhc2VSZWYodGFzayk7XG4gICAgICAgICAgICAgICAgICAgIGRvbmUoZXJyKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmZXRjaFBpcGVsaW5lLmFzeW5jKHN1YlRhc2spO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmaXJzdFRhc2spIGRlY3JlYXNlUmVmKHRhc2spO1xuICAgICAgICBkb25lKCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGRlY3JlYXNlUmVmICh0YXNrKSB7XG4gICAgbGV0IG91dHB1dCA9IHRhc2sub3V0cHV0O1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gb3V0cHV0Lmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICBvdXRwdXRbaV0uY29udGVudCAmJiBvdXRwdXRbaV0uY29udGVudC5kZWNSZWYoZmFsc2UpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaGFuZGxlIChpdGVtLCB0YXNrLCBjb250ZW50LCBmaWxlLCBsb2FkRGVwZW5kcywgZGVwZW5kcywgbGFzdCwgZG9uZSkge1xuXG4gICAgdmFyIGV4Y2x1ZGUgPSB0YXNrLm9wdGlvbnMuX19leGNsdWRlX187XG4gICAgdmFyIHByb2dyZXNzID0gdGFzay5wcm9ncmVzcztcblxuICAgIGl0ZW0uY29udGVudCA9IGNvbnRlbnQ7XG4gICAgaXRlbS5maWxlID0gZmlsZTtcbiAgICB0YXNrLm91dHB1dC5wdXNoKGl0ZW0pO1xuXG4gICAgaWYgKGxvYWREZXBlbmRzKSB7XG4gICAgICAgIGV4Y2x1ZGVbaXRlbS51dWlkXSA9IHRydWU7XG4gICAgICAgIGdldERlcGVuZHMoaXRlbS51dWlkLCBmaWxlIHx8IGNvbnRlbnQsIGV4Y2x1ZGUsIGRlcGVuZHMsIHRydWUsIGZhbHNlLCBpdGVtLmNvbmZpZyk7XG4gICAgICAgIHByb2dyZXNzLnRvdGFsID0gbGFzdCArIGRlcGVuZHMubGVuZ3RoO1xuICAgIH1cblxuICAgIHByb2dyZXNzLmNhbkludm9rZSAmJiB0YXNrLmRpc3BhdGNoKCdwcm9ncmVzcycsICsrcHJvZ3Jlc3MuZmluaXNoLCBwcm9ncmVzcy50b3RhbCwgaXRlbSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmV0Y2g7Il0sInNvdXJjZVJvb3QiOiIvIn0=